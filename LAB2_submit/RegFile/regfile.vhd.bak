-- Top-level 32x32 register file
library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity regfile is
    port (
        clk      : in  std_logic;
        rst      : in  std_logic;
        we       : in  std_logic;  -- Write enable
        wd       : in  std_logic_vector(31 downto 0); -- Write data
        wa       : in  std_logic_vector(4 downto 0);  -- Write address
        ra1      : in  std_logic_vector(4 downto 0);  -- Read address 1
        ra2      : in  std_logic_vector(4 downto 0);  -- Read address 2
        rd1      : out std_logic_vector(31 downto 0); -- Read data 1
        rd2      : out std_logic_vector(31 downto 0)  -- Read data 2
    );
end entity;

architecture rtl of regfile is
    component register_n is
        generic (N : integer := 32);
        port (
            clk   : in  std_logic;
            rst   : in  std_logic;
            en    : in  std_logic;
            d     : in  std_logic_vector(N-1 downto 0);
            q     : out std_logic_vector(N-1 downto 0)
        );
    end component;

    component decoder5t32 is
        port (
            inp  : in  std_logic_vector(4 downto 0);
            en   : in  std_logic;
            outp : out std_logic_vector(31 downto 0)
        );
    end component;

    component mux32_1 is
        port (
            data_in : in  std_logic_vector(32*32-1 downto 0);
            sel     : in  std_logic_vector(4 downto 0);
            y       : out std_logic_vector(31 downto 0)
        );
    end component;

    signal reg_out : std_logic_vector(32*32-1 downto 0);
    signal we_vec  : std_logic_vector(31 downto 0);
begin
    -- Decoder for write enable
    dec: decoder5t32 port map(inp => wa, en => we, outp => we_vec);

    -- Registers (register 0 hardwired to zero)
    gen_regs: for i in 0 to 31 generate
        reg_inst: register_n
            generic map(N => 32)
            port map(
                clk => clk,
                rst => rst,
                en  => we_vec(i) when i /= 0 else '0',  -- reg[0] is always zero
                d   => wd,
                q   => reg_out((i+1)*32-1 downto i*32)
            );
    end generate;

    -- Read multiplexers
    mux1: mux32_1 port map(data_in => reg_out, sel => ra1, y => rd1);
    mux2: mux32_1 port map(data_in => reg_out, sel => ra2, y => rd2);
end architecture;